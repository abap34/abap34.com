{
"meta": {
   "author": "abap34",   "css_setting": "assets/modern-light.css",   "date": "2024/04/02",   "description": "GitHub Actions を利用して、リリース時に自動で Docker Hub にイメージをアップロードして、そのイメージを利用する方法を紹介します。",   "editor_theme": "ace/theme/monokai",   "github_id": "abap34",   "mail": "abap0002@gmail.com",   "ogp_url": "https://images.dog.ceo/breeds/basenji/n02110806_4199.jpg",   "out_path": "public/posts/almo_autorelease.html",   "site_name": "abap34's blog",   "syntax_theme": "monokai.min",   "tag": "[Docker, Docker Hub, GitHub Actions, CI/CD, 日記]",   "template_file": "assets/template.html",   "theme": "light",   "title": "GitHub Actionsでリリース時に自動ビルド + Docker Hubにイメージアップロード + GitHub Actionsから利用",   "twitter_id": "abap34",   "twitter_site": "@abap34",   "url": "https://abap34.com/posts/almo_autorelease.html"} 
,
"ir": {"class":"Block","uuid":"0","childs":[{"class":"NewLine","uuid":"1"},{"class":"Header","level":"2","uuid":"2","childs":[{"class":"Block","uuid":"3","childs":[{"class":"Block","uuid":"4","childs":[{"class":"RawText","content":"いろいろ大変リリース作業","uuid":"5"}]}]}]},{"class":"NewLine","uuid":"6"},{"class":"Block","uuid":"7","childs":[{"class":"Block","uuid":"8","childs":[{"class":"RawText","content":"<a href=\u0022https://github.com/abap34/ALMO\u0022><img src=\u0022https://gh-card.dev/repos/abap34/ALMO.svg\u0022></a>","uuid":"9"}]}]},{"class":"NewLine","uuid":"10"},{"class":"NewLine","uuid":"11"},{"class":"Block","uuid":"12","childs":[{"class":"Block","uuid":"13","childs":[{"class":"RawText","content":"を毎日たのしく開発しています。","uuid":"14"}]}]},{"class":"NewLine","uuid":"15"},{"class":"Block","uuid":"16","childs":[{"class":"Block","uuid":"17","childs":[{"class":"RawText","content":"ところで、これは静的サイトジェネレータなので、いろんな人のブログなどに使ってもらうことを想定しています。","uuid":"18"}]}]},{"class":"NewLine","uuid":"19"},{"class":"NewLine","uuid":"20"},{"class":"Block","uuid":"21","childs":[{"class":"Block","uuid":"22","childs":[{"class":"RawText","content":"となると、 GitHub Actions などでも利用しやすいように環境を整える必要があります。","uuid":"23"}]}]},{"class":"NewLine","uuid":"24"},{"class":"Block","uuid":"25","childs":[{"class":"Block","uuid":"26","childs":[{"class":"Block","uuid":"28","childs":[{"class":"RawText","content":"GitHub Actions では、 ","uuid":"29"}]},{"class":"InlineCodeBlock","code":"use: docker://hoge/huga:latest","uuid":"27"},{"class":"Block","uuid":"30","childs":[{"class":"RawText","content":" のように指定することで Docker Hub にあるイメージを利用することができます。","uuid":"31"}]}]}]},{"class":"NewLine","uuid":"32"},{"class":"NewLine","uuid":"33"},{"class":"Block","uuid":"34","childs":[{"class":"Block","uuid":"35","childs":[{"class":"RawText","content":"そこで、リリースを打つたびに Docker イメージをビルドして、 Docker Hub にアップロードするようにします。作業記録です。","uuid":"36"}]}]},{"class":"NewLine","uuid":"37"},{"class":"Header","level":"3","uuid":"38","childs":[{"class":"Block","uuid":"39","childs":[{"class":"Block","uuid":"40","childs":[{"class":"RawText","content":"Docker Hub にイメージをアップロードする","uuid":"41"}]}]}]},{"class":"NewLine","uuid":"42"},{"class":"Block","uuid":"43","childs":[{"class":"Block","uuid":"44","childs":[{"class":"RawText","content":"とりあえず Dockerfile を作ります。","uuid":"45"}]}]},{"class":"NewLine","uuid":"46"},{"class":"CodeBlock","code":"FROM alpine:latest\u000a\u000aRUN apk add --no-cache g++\u000a\u000aRUN apk add --no-cache bash\u000a\u000aWORKDIR /app\u000a\u000aCOPY . .\u000a\u000aRUN bash build.sh\u000a\u000aENTRYPOINT [ \u0022./docker-entrypoint.sh\u0022 ]\u000a","language":"Dockerfile","uuid":"47"},{"class":"NewLine","uuid":"48"},{"class":"Block","uuid":"49","childs":[{"class":"Block","uuid":"50","childs":[{"class":"Block","uuid":"52","childs":[{"class":"RawText","content":"","uuid":"53"}]},{"alt":"Docker Hub","class":"InlineUrl","url":"https://hub.docker.com/","uuid":"51"},{"class":"Block","uuid":"54","childs":[{"class":"RawText","content":" で My Account > Security > New Access Token からトークンを取得します。","uuid":"55"}]}]}]},{"class":"NewLine","uuid":"56"},{"class":"Block","uuid":"57","childs":[{"class":"Block","uuid":"58","childs":[{"class":"Block","uuid":"60","childs":[{"class":"Block","uuid":"62","childs":[{"class":"RawText","content":"次にレポジトリの Settings > Security > Secrets and variables > New Repository Secret から ","uuid":"63"}]},{"class":"InlineCodeBlock","code":"DOCKERHUB_USERNAME","uuid":"61"},{"class":"Block","uuid":"64","childs":[{"class":"RawText","content":" と ","uuid":"65"}]}]},{"class":"InlineCodeBlock","code":"DOCKERHUB_TOKEN","uuid":"59"},{"class":"Block","uuid":"66","childs":[{"class":"RawText","content":" を設定します。","uuid":"67"}]}]}]},{"class":"NewLine","uuid":"68"},{"class":"NewLine","uuid":"69"},{"class":"Block","uuid":"70","childs":[{"class":"Block","uuid":"71","childs":[{"class":"RawText","content":"あとは以下のように GitHub Actions を設定します。","uuid":"72"}]}]},{"class":"NewLine","uuid":"73"},{"class":"CodeBlock","code":"name: Build and push Docker image\u000a\u000aon:\u000a  release:\u000a    types: [published]\u000a\u000ajobs:\u000a  build:\u000a    runs-on: ubuntu-latest\u000a    steps:\u000a      - name: Checkout code\u000a        uses: actions/checkout@v2\u000a\u000a      - name: Login to DockerHub\u000a        uses: docker/login-action@v2\u000a        with:\u000a          username: ${{ secrets.DOCKERHUB_USERNAME }}\u000a          password: ${{ secrets.DOCKERHUB_TOKEN }}\u000a\u000a      - name: Build and push Docker image\u000a        uses: docker/build-push-action@v2\u000a        with:\u000a          context: .\u000a          file: ./Dockerfile\u000a          push: true\u000a          tags: ${{ secrets.DOCKERHUB_USERNAME }}/almo:latest\u000a","language":"yaml","uuid":"74"},{"class":"NewLine","uuid":"75"},{"class":"NewLine","uuid":"76"},{"class":"Block","uuid":"77","childs":[{"class":"Block","uuid":"78","childs":[{"class":"Block","uuid":"80","childs":[{"class":"Block","uuid":"82","childs":[{"class":"Block","uuid":"84","childs":[{"class":"RawText","content":"注意ポイントとしては、 GitHub Actions からこのイメージを利用するときは ","uuid":"85"}]},{"class":"InlineCodeBlock","code":"WORKDIR","uuid":"83"},{"class":"Block","uuid":"86","childs":[{"class":"RawText","content":" などが上書きされるみたいなので気をつけて ","uuid":"87"}]}]},{"class":"InlineCodeBlock","code":"Dockerfile","uuid":"81"},{"class":"Block","uuid":"88","childs":[{"class":"RawText","content":" と ","uuid":"89"}]}]},{"class":"InlineCodeBlock","code":"docker-entrypoint.sh","uuid":"79"},{"class":"Block","uuid":"90","childs":[{"class":"RawText","content":" を作らないとハマります。","uuid":"91"}]}]}]},{"class":"NewLine","uuid":"92"},{"class":"Block","uuid":"93","childs":[{"class":"Block","uuid":"94","childs":[{"class":"Block","uuid":"96","childs":[{"class":"RawText","content":"","uuid":"97"}]},{"caption":"run の引数","class":"InlineImage","url":"almo_autorelease/image.png","uuid":"95"},{"class":"Block","uuid":"98","childs":[{"class":"RawText","content":"","uuid":"99"}]}]}]},{"class":"NewLine","uuid":"100"},{"class":"NewLine","uuid":"101"},{"class":"Block","uuid":"102","childs":[{"class":"Block","uuid":"103","childs":[{"class":"RawText","content":"これで、リリース時に Docker イメージをビルドして Docker Hub にアップロードすることができるようになりました。","uuid":"104"}]}]},{"class":"NewLine","uuid":"105"},{"class":"Block","uuid":"106","childs":[{"class":"Block","uuid":"107","childs":[{"class":"Block","uuid":"109","childs":[{"class":"RawText","content":"","uuid":"110"}]},{"caption":"","class":"InlineImage","url":"almo_autorelease/almo.png","uuid":"108"},{"class":"Block","uuid":"111","childs":[{"class":"RawText","content":"","uuid":"112"}]}]}]},{"class":"NewLine","uuid":"113"},{"class":"Header","level":"3","uuid":"114","childs":[{"class":"Block","uuid":"115","childs":[{"class":"Block","uuid":"116","childs":[{"class":"RawText","content":"リリース時にいろんなプラットフォームに対応する","uuid":"117"}]}]}]},{"class":"NewLine","uuid":"118"},{"class":"Block","uuid":"119","childs":[{"class":"Block","uuid":"120","childs":[{"class":"RawText","content":"コレは、 GitHub Actions でマトリクスビルドを使うことで簡単に実現できます。","uuid":"121"}]}]},{"class":"NewLine","uuid":"122"},{"class":"CodeBlock","code":"name: Release for all platforms\u000a\u000aon:\u000a  release:\u000a    types: [published]\u000a\u000ajobs:\u000a  build_and_upload:\u000a    runs-on: ubuntu-latest\u000a    strategy:\u000a      matrix:\u000a        os: [ubuntu-latest, windows-latest, macos-14]\u000a\u000a    steps:\u000a      - name: Checkout code\u000a        uses: actions/checkout@v2\u000a\u000a      - name: Build\u000a        run: bash build.sh\u000a\u000a      - name: Upload Release\u000a        uses: actions/upload-release-asset@v1\u000a        with:\u000a          upload_url: ${{ github.event.release.upload_url }}\u000a          asset_path: build/almo\u000a          asset_name: ${{ matrix.os }}\u000a          asset_content_type: application/octet-stream \u000a        env:\u000a          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\u000a","language":"yaml","uuid":"123"},{"class":"NewLine","uuid":"124"},{"class":"NewLine","uuid":"125"},{"class":"Block","uuid":"126","childs":[{"class":"Block","uuid":"127","childs":[{"class":"RawText","content":"便利ですね。","uuid":"128"}]}]},{"class":"NewLine","uuid":"129"},{"class":"NewLine","uuid":"130"},{"class":"Header","level":"3","uuid":"131","childs":[{"class":"Block","uuid":"132","childs":[{"class":"Block","uuid":"133","childs":[{"class":"RawText","content":"使用例","uuid":"134"}]}]}]},{"class":"NewLine","uuid":"135"},{"class":"Block","uuid":"136","childs":[{"class":"Block","uuid":"137","childs":[{"class":"RawText","content":"Docker Hubにアップロードしたおかげで","uuid":"138"}]}]},{"class":"Block","uuid":"139","childs":[{"class":"Block","uuid":"140","childs":[{"class":"RawText","content":"誰でも簡単にビルドができるようになりました。","uuid":"141"}]}]},{"class":"NewLine","uuid":"142"},{"class":"CodeBlock","code":"docker pull abap/almo:latest\u000a","language":"bash","uuid":"143"},{"class":"NewLine","uuid":"144"},{"class":"Block","uuid":"145","childs":[{"class":"Block","uuid":"146","childs":[{"class":"RawText","content":"して、","uuid":"147"}]}]},{"class":"NewLine","uuid":"148"},{"class":"CodeBlock","code":"docker run abap/almo:latest example.md\u000a","language":"bash","uuid":"149"},{"class":"NewLine","uuid":"150"},{"class":"Block","uuid":"151","childs":[{"class":"Block","uuid":"152","childs":[{"class":"RawText","content":"するだけで利用できます。　便利！","uuid":"153"}]}]},{"class":"NewLine","uuid":"154"},{"class":"NewLine","uuid":"155"},{"class":"Block","uuid":"156","childs":[{"class":"Block","uuid":"157","childs":[{"class":"RawText","content":"GitHub Actions からも","uuid":"158"}]}]},{"class":"NewLine","uuid":"159"},{"class":"CodeBlock","code":"uses: docker://abap/almo:latest\u000aargs:\u000a    example.md\u000a","language":"yaml","uuid":"160"},{"class":"NewLine","uuid":"161"},{"class":"Block","uuid":"162","childs":[{"class":"Block","uuid":"163","childs":[{"class":"RawText","content":"だけで利用できます。","uuid":"164"}]}]},{"class":"NewLine","uuid":"165"},{"class":"Header","level":"2","uuid":"166","childs":[{"class":"Block","uuid":"167","childs":[{"class":"Block","uuid":"168","childs":[{"class":"RawText","content":"おわりに","uuid":"169"}]}]}]},{"class":"NewLine","uuid":"170"},{"class":"Block","uuid":"171","childs":[{"class":"Block","uuid":"172","childs":[{"class":"RawText","content":"終わりです。","uuid":"173"}]}]},{"class":"NewLine","uuid":"174"},{"class":"NewLine","uuid":"175"},{"class":"Header","level":"2","uuid":"176","childs":[{"class":"Block","uuid":"177","childs":[{"class":"Block","uuid":"178","childs":[{"class":"RawText","content":"今日の一曲","uuid":"179"}]}]}]},{"class":"NewLine","uuid":"180"},{"class":"Block","uuid":"181","childs":[{"class":"Block","uuid":"182","childs":[{"class":"RawText","content":"<iframe width=\u0022560\u0022 height=\u0022315\u0022 src=\u0022https://www.youtube.com/embed/EJ8lBjQls4w?si=PdBx5TBPvW-z3_ZG\u0022 title=\u0022YouTube video player\u0022 frameborder=\u00220\u0022 allow=\u0022accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share\u0022 referrerpolicy=\u0022strict-origin-when-cross-origin\u0022 allowfullscreen></iframe>","uuid":"183"}]}]},{"class":"NewLine","uuid":"184"}]}
}

